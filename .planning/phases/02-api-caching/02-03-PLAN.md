---
phase: 02-api-caching
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/services/hours_service.py
  - backend/app/routers/open_now.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "GET /api/v2/open-now returns only halls currently serving a meal based on DiningHours schedule"
    - "DiningHoursOverride records (date-specific closures) take precedence over regular DiningHours"
    - "Time comparison uses Pacific timezone (America/Los_Angeles), not UTC"
  artifacts:
    - path: "backend/app/services/hours_service.py"
      provides: "Hours lookup and open-now evaluation logic"
      contains: "get_open_halls"
    - path: "backend/app/routers/open_now.py"
      provides: "GET /open-now endpoint"
      contains: "router"
  key_links:
    - from: "backend/app/routers/open_now.py"
      to: "backend/app/services/hours_service.py"
      via: "function call in route handler"
      pattern: "get_open_halls"
    - from: "backend/app/services/hours_service.py"
      to: "backend/app/models/dining_hours.py"
      via: "SQLAlchemy select queries"
      pattern: "select.*DiningHours"
    - from: "backend/app/main.py"
      to: "backend/app/routers/open_now.py"
      via: "app.include_router"
      pattern: "include_router.*open_now"
---

<objective>
Build the hours service and open-now endpoint that returns currently-open dining halls based on the DiningHours schedule with override support.

Purpose: Students need to know which halls are open right now. This endpoint evaluates current Pacific time against the DiningHours table (with date-specific override precedence) to return only halls currently serving a meal.
Output: A working /api/v2/open-now endpoint returning open halls with their current meal period.
</objective>

<execution_context>
@/Users/felixpeng/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felixpeng/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-caching/02-RESEARCH.md
@.planning/phases/02-api-caching/02-01-SUMMARY.md
@backend/app/main.py
@backend/app/dependencies.py
@backend/app/config.py
@backend/app/models/dining_hours.py
@backend/app/models/dining_hall.py
@backend/app/schemas/open_now.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hours service with open-now evaluation logic</name>
  <files>
    backend/app/services/hours_service.py
  </files>
  <action>
    1. Create `backend/app/services/hours_service.py`:
       - Import datetime as _dt, ZoneInfo from zoneinfo, select from sqlalchemy, AsyncSession
       - Import DiningHours, DiningHoursOverride from app.models.dining_hours
       - Import DiningHall from app.models.dining_hall

    2. Implement `async def get_open_halls(session: AsyncSession, tz_name: str) -> list[dict]`:
       - Get current Pacific time: `now = _dt.datetime.now(ZoneInfo(tz_name))`
       - Extract `current_time = now.time()` and `current_dow = now.isoweekday() % 7` (converts Monday=1..Sunday=7 to Sunday=0..Saturday=6)
       - Query DiningHoursOverride for today's date: `select(DiningHoursOverride).where(DiningHoursOverride.date == now.date())`
       - Build override lookup dict: `{(o.hall_id, o.meal): o for o in overrides}`
       - Query DiningHours for today's day_of_week where is_active=True: `select(DiningHours).where(DiningHours.day_of_week == current_dow, DiningHours.is_active == True)`
       - For each regular hours row:
         - Check if override exists for (hall_id, meal)
         - If override exists with start_time=None -> hall is closed for this meal (skip)
         - If override exists with start_time/end_time -> use override times instead
         - Otherwise use regular hours start_time/end_time
         - If `start_time <= current_time <= end_time` -> hall is open, record hall_id and meal
       - Also check for override-only entries (overrides where hall+meal has no regular hours row but override has times) -- these represent special openings
       - Query DiningHall table to get hall metadata (name, college, color) for all open hall_ids
       - Return list of dicts: {"id": hall_id, "name": hall.name, "college": hall.college, "color": hall.color, "current_meal": meal}
       - If a hall is open for multiple meals simultaneously (unlikely but possible), include it once with the meal that started most recently

    3. Accept an optional `now_override: _dt.datetime | None = None` parameter for testability:
       - If provided, use it instead of _dt.datetime.now(ZoneInfo(tz_name))
       - This allows tests to set a fixed time without mocking
  </action>
  <verify>
    - `cd backend && python -c "from app.services.hours_service import get_open_halls; print('ok')"` succeeds
  </verify>
  <done>
    Hours service evaluates current Pacific time against DiningHours table with override precedence. Returns list of open halls with current meal. Accepts time override for testing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create open-now router and wire into FastAPI app</name>
  <files>
    backend/app/routers/open_now.py
    backend/app/main.py
  </files>
  <action>
    1. Create `backend/app/routers/open_now.py`:
       - Create APIRouter with tags=["open-now"]
       - GET "/" endpoint (mounted at /api/v2/open-now by main.py)
       - Dependency: session via Depends(get_session)
       - Get timezone from settings: `get_settings().timezone`
       - Call `get_open_halls(session, timezone)`
       - Return `list[OpenHallResponse]` by mapping each dict to OpenHallResponse
       - Import from app.dependencies, app.services.hours_service, app.schemas.open_now, app.config

    2. Update `backend/app/main.py`:
       - Import open_now router: `from app.routers import open_now`
       - Add `app.include_router(open_now.router, prefix="/api/v2/open-now")` after menus router
       - Remove any remaining placeholder comments
  </action>
  <verify>
    - `cd backend && python -c "from app.routers.open_now import router; print('ok')"` succeeds
    - `python -c "from app.main import app; routes = [r.path for r in app.routes]; print('open-now' in str(routes))"` confirms open-now route registered
  </verify>
  <done>
    Open-now endpoint returns list of currently-open halls with current meal. Wired into main app at /api/v2/open-now. All three routers (halls, menus, open-now) now mounted in the FastAPI app.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && python -c "from app.services.hours_service import get_open_halls; print('hours service ok')"` passes
2. `python -c "from app.routers.open_now import router; print('router ok')"` passes
3. `python -c "from app.main import app; routes = [r.path for r in app.routes]; assert any('open-now' in str(r) for r in routes); print('all routes mounted')"` passes
</verification>

<success_criteria>
- Hours service evaluates DiningHours table with override precedence
- Time comparison uses Pacific timezone from config
- Override with start_time=None means closed (skip)
- Override with times means use those times instead of regular
- Open-now endpoint returns OpenHallResponse list
- Open-now router mounted in main app at /api/v2/open-now
- Now_override parameter enables deterministic testing
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-caching/02-03-SUMMARY.md`
</output>
