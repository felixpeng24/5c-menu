---
phase: 02-api-caching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/app/config.py
  - backend/app/main.py
  - backend/app/redis.py
  - backend/app/dependencies.py
  - backend/app/models/dining_hours.py
  - backend/app/models/__init__.py
  - backend/app/schemas/__init__.py
  - backend/app/schemas/halls.py
  - backend/app/schemas/menus.py
  - backend/app/schemas/open_now.py
  - backend/app/routers/__init__.py
  - backend/app/routers/halls.py
autonomous: true

must_haves:
  truths:
    - "FastAPI app starts and responds to requests at /api/v2/ prefix"
    - "GET /api/v2/halls returns a list of dining hall metadata from the database"
    - "DiningHours and DiningHoursOverride models exist and can be imported"
    - "Redis client is initialized during app lifespan and available via dependency injection"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI application with lifespan, CORS, router mounts"
      contains: "lifespan"
    - path: "backend/app/redis.py"
      provides: "Redis client lifecycle management"
      contains: "redis.asyncio"
    - path: "backend/app/dependencies.py"
      provides: "Shared dependency providers for session and redis"
      exports: ["get_redis", "get_session"]
    - path: "backend/app/models/dining_hours.py"
      provides: "DiningHours and DiningHoursOverride SQLModel tables"
      contains: "DiningHours"
    - path: "backend/app/schemas/halls.py"
      provides: "HallResponse Pydantic model"
      contains: "HallResponse"
    - path: "backend/app/schemas/menus.py"
      provides: "MenuResponse, StationResponse, MenuItemResponse Pydantic models"
      contains: "MenuResponse"
    - path: "backend/app/schemas/open_now.py"
      provides: "OpenHallResponse Pydantic model"
      contains: "OpenHallResponse"
    - path: "backend/app/routers/halls.py"
      provides: "GET /halls endpoint"
      contains: "router"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/routers/halls.py"
      via: "app.include_router"
      pattern: "include_router.*halls"
    - from: "backend/app/main.py"
      to: "backend/app/redis.py"
      via: "lifespan context manager"
      pattern: "app.state.redis"
    - from: "backend/app/routers/halls.py"
      to: "backend/app/dependencies.py"
      via: "Depends injection"
      pattern: "Depends.*get_session"
---

<objective>
Set up the FastAPI application scaffold with Redis lifecycle, shared dependencies, DiningHours data model, Pydantic response schemas for all three endpoints, and the halls endpoint.

Purpose: Establish the API foundation that all other Phase 2 plans build on -- app entry point, dependency injection, response contracts, and the simplest endpoint (halls) as proof of working infrastructure.
Output: A running FastAPI app with /api/v2/halls returning hall metadata, Redis connected via lifespan, and all response schemas defined.
</objective>

<execution_context>
@/Users/felixpeng/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felixpeng/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-caching/02-RESEARCH.md
@.planning/phases/01-parsers-data-models/01-01-SUMMARY.md
@backend/app/config.py
@backend/app/db.py
@backend/app/models/__init__.py
@backend/app/models/dining_hall.py
@backend/app/models/menu.py
@backend/app/models/enums.py
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, update config, create Redis lifecycle and shared dependencies</name>
  <files>
    backend/pyproject.toml
    backend/app/config.py
    backend/app/redis.py
    backend/app/dependencies.py
  </files>
  <action>
    1. Add new dependencies to pyproject.toml:
       - Add to `dependencies`: `"fastapi[standard]"`, `"redis[hiredis]"`, `"uvicorn"`
       - Add to `[project.optional-dependencies] dev`: `"fakeredis[json]"`, `"asgi-lifespan"`, `"anyio"`
       - Run `pip install -e ".[dev]"` to install

    2. Update `backend/app/config.py`:
       - Add `redis_url: str = "redis://localhost:6379/0"` to Settings class
       - Add `allowed_origins: list[str] = ["http://localhost:3000"]` to Settings class
       - Keep existing fields (database_url, timezone) and env_prefix unchanged

    3. Create `backend/app/redis.py`:
       - Import `redis.asyncio as aioredis`
       - Function `create_redis(url: str) -> aioredis.Redis` that calls `aioredis.from_url(url, decode_responses=True)`
       - This is NOT a module-level client -- the lifespan in main.py will call this and store on app.state

    4. Create `backend/app/dependencies.py`:
       - Import `AsyncSession` from sqlalchemy, `Redis` from redis.asyncio, `Request` from fastapi, `Depends` from fastapi
       - Import `get_session` from `app.db` and re-export it (so routes import from one place)
       - Function `get_redis(request: Request) -> Redis` that returns `request.app.state.redis`
       - Both functions should have return type annotations
  </action>
  <verify>
    - `cd backend && pip install -e ".[dev]"` completes without errors
    - `python -c "from app.config import get_settings; s = get_settings(); print(s.redis_url)"` prints redis URL
    - `python -c "from app.redis import create_redis; print('ok')"` succeeds
    - `python -c "from app.dependencies import get_redis, get_session; print('ok')"` succeeds
  </verify>
  <done>
    All new dependencies installed. Settings has redis_url and allowed_origins. Redis creation function exists. Dependency providers for redis and session exist in a single module.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DiningHours model, response schemas, FastAPI app, and halls endpoint</name>
  <files>
    backend/app/models/dining_hours.py
    backend/app/models/__init__.py
    backend/app/schemas/__init__.py
    backend/app/schemas/halls.py
    backend/app/schemas/menus.py
    backend/app/schemas/open_now.py
    backend/app/routers/__init__.py
    backend/app/routers/halls.py
    backend/app/main.py
  </files>
  <action>
    1. Create `backend/app/models/dining_hours.py`:
       - Use `import datetime as _dt` pattern (same as menu.py) to avoid Pydantic date/time clashes
       - DiningHours SQLModel table: id (int PK), hall_id (FK to dining_halls.id, indexed), day_of_week (int, 0=Sunday..6=Saturday), meal (str, max_length=20), start_time (_dt.time), end_time (_dt.time), is_active (bool, default=True)
       - UniqueConstraint on (hall_id, day_of_week, meal) named "uq_hours_hall_day_meal"
       - DiningHoursOverride SQLModel table: id (int PK), hall_id (FK to dining_halls.id, indexed), date (_dt.date), meal (str|None, max_length=20), start_time (_dt.time|None), end_time (_dt.time|None), reason (str|None, max_length=200)
       - UniqueConstraint on (hall_id, date, meal) named "uq_override_hall_date_meal"
       - __tablename__ = "dining_hours" and "dining_hours_overrides"

    2. Update `backend/app/models/__init__.py`:
       - Add imports for DiningHours and DiningHoursOverride
       - Add to __all__

    3. Create `backend/app/schemas/` directory with `__init__.py` (empty)

    4. Create `backend/app/schemas/halls.py`:
       - HallResponse(BaseModel): id (str), name (str), college (str), vendor_type (str), color (str | None = None)

    5. Create `backend/app/schemas/menus.py`:
       - MenuItemResponse(BaseModel): name (str), tags (list[str] = [])
       - StationResponse(BaseModel): name (str), items (list[MenuItemResponse])
       - MenuResponse(BaseModel): hall_id (str), date (str), meal (str), stations (list[StationResponse]), is_stale (bool = False), fetched_at (str | None = None)

    6. Create `backend/app/schemas/open_now.py`:
       - OpenHallResponse(BaseModel): id (str), name (str), college (str), color (str | None = None), current_meal (str)

    7. Create `backend/app/routers/` directory with `__init__.py` (empty)

    8. Create `backend/app/routers/halls.py`:
       - Create APIRouter with tags=["halls"]
       - GET "/" endpoint (mounted at /api/v2/halls by main.py)
       - Accepts `session: AsyncSession = Depends(get_session)`
       - Queries all DiningHall rows via `select(DiningHall)`, ordered by name
       - Returns `list[HallResponse]` by mapping each DiningHall row to HallResponse
       - Import dependencies from `app.dependencies`

    9. Create `backend/app/main.py`:
       - Import asynccontextmanager from contextlib
       - Import FastAPI, CORSMiddleware
       - Import get_settings from app.config
       - Import create_redis from app.redis
       - Import halls router (menus and open_now will be added by later plans)
       - Lifespan context manager: create redis client via create_redis(settings.redis_url), store on app.state.redis, yield, then await app.state.redis.aclose()
       - Create FastAPI instance with title="5C Menu API", version="2.0.0", lifespan=lifespan
       - Add CORSMiddleware with settings.allowed_origins, allow_credentials=True, allow_methods=["GET"], allow_headers=["*"]
       - Include halls router with prefix="/api/v2/halls"
       - Add comment placeholders for menus and open_now routers (to be added in plans 02-02 and 02-03)
  </action>
  <verify>
    - `python -c "from app.models.dining_hours import DiningHours, DiningHoursOverride; print('ok')"` succeeds
    - `python -c "from app.schemas.halls import HallResponse; print('ok')"` succeeds
    - `python -c "from app.schemas.menus import MenuResponse, StationResponse, MenuItemResponse; print('ok')"` succeeds
    - `python -c "from app.schemas.open_now import OpenHallResponse; print('ok')"` succeeds
    - `python -c "from app.routers.halls import router; print('ok')"` succeeds
    - `python -c "from app.main import app; print(app.title)"` prints "5C Menu API"
  </verify>
  <done>
    DiningHours and DiningHoursOverride models exist with correct constraints. All three endpoint response schemas are defined. Halls router queries DiningHall table and returns HallResponse list. FastAPI app initializes with lifespan (Redis), CORS, and halls router mounted at /api/v2/halls.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && python -c "from app.main import app; print(app.title, app.version)"` outputs "5C Menu API 2.0.0"
2. `python -c "from app.models import DiningHall, Menu, DiningHours, DiningHoursOverride; print('all models ok')"` succeeds
3. `python -c "from app.schemas.halls import HallResponse; from app.schemas.menus import MenuResponse; from app.schemas.open_now import OpenHallResponse; print('all schemas ok')"` succeeds
4. `python -c "from app.dependencies import get_redis, get_session; print('deps ok')"` succeeds
</verification>

<success_criteria>
- FastAPI app importable and configured with lifespan, CORS, title/version
- Redis lifecycle managed via lifespan (not module-level)
- DiningHours + DiningHoursOverride SQLModel tables with correct constraints
- HallResponse, MenuResponse, OpenHallResponse schemas defined
- Halls router returns list[HallResponse] from database query
- All new dependencies installed and importable
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-caching/02-01-SUMMARY.md`
</output>
