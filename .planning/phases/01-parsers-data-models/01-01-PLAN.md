---
phase: 01-parsers-data-models
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/requirements.txt
  - backend/app/__init__.py
  - backend/app/config.py
  - backend/app/db.py
  - backend/app/models/__init__.py
  - backend/app/models/enums.py
  - backend/app/models/dining_hall.py
  - backend/app/models/menu.py
  - backend/app/parsers/__init__.py
  - backend/app/parsers/base.py
  - backend/app/parsers/station_filters.py
  - backend/tests/__init__.py
  - backend/tests/conftest.py
  - backend/alembic.ini
  - backend/alembic/env.py
  - backend/alembic/versions/.gitkeep
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Python project is installable with all required dependencies (httpx, selectolax, sqlmodel, asyncpg, pytest, etc.)"
    - "SQLModel models define the hall->date->meal->stations(JSONB) hierarchy"
    - "Parser base class enforces fetch_raw/parse separation for testability"
    - "Station filter configs for all 3 vendors are data-driven and match v1 PHP behavior exactly"
    - "Dietary tag normalization maps vendor-specific labels to canonical tags"
  artifacts:
    - path: "backend/pyproject.toml"
      provides: "Project metadata and dependency declarations"
    - path: "backend/app/models/menu.py"
      provides: "Menu and DiningHall SQLModel tables"
      contains: "class Menu"
    - path: "backend/app/parsers/base.py"
      provides: "Abstract parser base class"
      contains: "class BaseParser"
    - path: "backend/app/parsers/station_filters.py"
      provides: "Station filter configs for Sodexo, Bon Appetit, Pomona"
      contains: "SODEXO_FILTER"
    - path: "backend/app/models/enums.py"
      provides: "MealPeriod, College, VendorType, DietaryTag enums"
      contains: "class DietaryTag"
  key_links:
    - from: "backend/app/parsers/base.py"
      to: "backend/app/models/menu.py"
      via: "ParsedMenu/ParsedStation/ParsedMenuItem data classes used as return types"
      pattern: "ParsedMenu"
    - from: "backend/app/parsers/station_filters.py"
      to: "backend/app/parsers/base.py"
      via: "StationFilterConfig consumed by apply_station_filters in base"
      pattern: "StationFilterConfig"
---

<objective>
Set up the Python backend project with all dependencies, SQLModel data models, parser base class, station filter configurations, and dietary tag normalization.

Purpose: Every parser implementation (Plans 02-04) depends on these shared foundations. The models define how menu data is stored, the base class enforces fetch/parse separation for testability, and station filter configs replicate v1 behavior.

Output: Installable Python project with models, base parser, and station filter data for all 3 vendors.
</objective>

<execution_context>
@/Users/felixpeng/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felixpeng/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-parsers-data-models/01-CONTEXT.md
@.planning/phases/01-parsers-data-models/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project setup, config, and SQLModel data models</name>
  <files>
    backend/pyproject.toml
    backend/requirements.txt
    backend/app/__init__.py
    backend/app/config.py
    backend/app/db.py
    backend/app/models/__init__.py
    backend/app/models/enums.py
    backend/app/models/dining_hall.py
    backend/app/models/menu.py
    backend/alembic.ini
    backend/alembic/env.py
    backend/alembic/versions/.gitkeep
    backend/tests/__init__.py
    backend/tests/conftest.py
  </files>
  <action>
    1. Create `backend/pyproject.toml` with project metadata and dependencies:
       - Core: httpx>=0.28.1, selectolax>=0.4.6, sqlmodel>=0.0.32, asyncpg, pydantic-settings
       - Parsing: beautifulsoup4 (fallback)
       - Database: alembic, psycopg2-binary
       - Dev: pytest, pytest-asyncio
       - Set Python >=3.11

    2. Create `backend/requirements.txt` mirroring pyproject.toml deps for pip install.

    3. Create `backend/app/config.py` using pydantic-settings:
       - `Settings` class with `database_url` (default: postgresql+asyncpg://localhost/fivec_menu), `timezone` (default: America/Los_Angeles)
       - `get_settings()` function with lru_cache

    4. Create `backend/app/db.py`:
       - Async SQLAlchemy engine creation from settings
       - `async_session_factory` using `async_sessionmaker`
       - `get_session` async generator for dependency injection
       - `init_db` function that creates all tables (for dev/test)

    5. Create `backend/app/models/enums.py`:
       - `MealPeriod` enum: BREAKFAST, BRUNCH, LUNCH, DINNER, LATE_NIGHT
       - `College` enum: HMC, CMC, SCRIPPS, PITZER, POMONA
       - `VendorType` enum: SODEXO, BONAPPETIT, POMONA
       - `DietaryTag` enum: VEGAN, VEGETARIAN, GLUTEN_FREE, HALAL, MINDFUL, BALANCED, FARM_TO_FORK, HUMANE
       - Use Python `enum.Enum` (not StrEnum) with lowercase string values for DB storage

    6. Create `backend/app/models/dining_hall.py`:
       - `DiningHall` SQLModel table:
         - `id: str` (primary key, max 20 chars) -- e.g., "hoch", "collins", "frank"
         - `name: str` (display name, e.g., "Hoch-Shanahan")
         - `college: str` (from College enum values)
         - `vendor_type: str` (from VendorType enum values)
         - `color: str | None` (hex color for later frontend use)

    7. Create `backend/app/models/menu.py`:
       - Pydantic models (NOT table=True) for parsed data interchange:
         - `ParsedMenuItem`: name (str), tags (list[str], default [])
         - `ParsedStation`: name (str), items (list[ParsedMenuItem])
         - `ParsedMeal`: meal (str), stations (list[ParsedStation])
         - `ParsedMenu`: hall_id (str), date (date), meals (list[ParsedMeal])

       - `Menu` SQLModel table:
         - `id: int | None` (primary key, auto-increment)
         - `hall_id: str` (foreign key to dining_halls.id, indexed)
         - `date: date` (indexed)
         - `meal: str` (lowercase meal period name)
         - `stations_json: str` (JSONB column -- use `Column(JSON)` from sqlalchemy)
         - `fetched_at: datetime` (default utcnow)
         - `is_valid: bool` (default True)
         - Add unique constraint on (hall_id, date, meal) using `__table_args__`

    8. Create `backend/app/models/__init__.py` re-exporting all models.

    9. Create `backend/alembic.ini` and `backend/alembic/env.py` configured for async PostgreSQL with SQLModel metadata. Create `backend/alembic/versions/.gitkeep`.

    10. Create `backend/tests/__init__.py` (empty) and `backend/tests/conftest.py` with basic pytest fixtures (e.g., sample ParsedMenu factory).

    11. Run `pip install -e "backend[dev]"` or `pip install -r backend/requirements.txt` to verify dependencies resolve.
  </action>
  <verify>
    - `cd /Users/felixpeng/Downloads/repos/5c-menu/backend && python -c "from app.models.menu import Menu, ParsedMenu, ParsedStation, ParsedMenuItem; from app.models.dining_hall import DiningHall; from app.models.enums import DietaryTag, MealPeriod; print('Models OK')"` succeeds
    - `cd /Users/felixpeng/Downloads/repos/5c-menu/backend && python -c "from app.config import get_settings; print(get_settings().timezone)"` prints "America/Los_Angeles"
  </verify>
  <done>
    - All SQLModel table models import without error
    - ParsedMenu/ParsedStation/ParsedMenuItem Pydantic models import and can be instantiated
    - Config loads with defaults
    - alembic.ini exists and is configured
  </done>
</task>

<task type="auto">
  <name>Task 2: Parser base class, station filter pipeline, and dietary tag normalization</name>
  <files>
    backend/app/parsers/__init__.py
    backend/app/parsers/base.py
    backend/app/parsers/station_filters.py
  </files>
  <action>
    1. Create `backend/app/parsers/base.py` with abstract base class:
       ```python
       class BaseParser(ABC):
           def __init__(self, hall_id: str, hall_name: str):
               ...
           @abstractmethod
           async def fetch_raw(self, target_date: date) -> str:
               """Fetch raw HTML/JSON. Returns raw text. Only I/O here."""
           @abstractmethod
           def parse(self, raw_content: str, target_date: date) -> ParsedMenu:
               """Pure parsing logic. No I/O. Testable against fixture files."""
           def validate(self, menu: ParsedMenu) -> bool:
               """Structural validation: at least 1 meal, each meal has >= min_station_count stations."""
           @property
           def min_station_count(self) -> int:
               """Override per vendor. Default 1."""
           async def fetch_and_parse(self, target_date: date) -> ParsedMenu | None:
               """Full pipeline: fetch -> parse -> validate. Returns None if invalid."""
       ```
       - `fetch_and_parse` should catch httpx exceptions and log warnings, returning None on failure
       - Use `import logging; logger = logging.getLogger(__name__)`

    2. Create `backend/app/parsers/station_filters.py` with:

       a. `StationFilterConfig` dataclass:
          - `hidden: list[str]` -- stations to remove (all lowercase)
          - `ordered: list[str]` -- station sort priority (all lowercase)
          - `truncated: dict[str, int]` -- station name -> max items, -1 means hide entirely
          - `combined: dict[str, list[str]]` -- canonical display name -> list of aliases (lowercase)

       b. `apply_station_filters(stations: list[ParsedStation], config: StationFilterConfig) -> list[ParsedStation]`:
          Pipeline in this exact order (matching v1 PHP logic):
          1. **Merge**: For each station, check if its lowercase name appears in any combined alias list. If so, rename to canonical name and merge items with any existing station of that canonical name.
          2. **Hide**: Remove stations whose lowercase name is in `hidden` list. Also remove stations where truncated value is -1.
          3. **Truncate**: For stations with a positive truncated value, keep only that many items.
          4. **Sort**: Sort by position in `ordered` list. Stations not in list get index 999 (sort to end). Preserve relative order of stations not in the list.
          5. **Remove empty**: Drop stations with 0 items.

       c. Three filter config constants -- MUST match v1 PHP exactly:

          `SODEXO_FILTER = StationFilterConfig(...)` from SodexoParser.php:
          - hidden: ["salad bar", "deli bar", "hot cereal", "sub connection", "deli bar hmc", "deli", "have a great day", "have a great day!", "rice", "potatoes", "sauces", "action-made to order"]
          - ordered: ["exhibition", "entree", "entrees", "dim sum", "entrees", "entree", "chicken entree", "beef entree", "fish/seafood entree", "pork", "action", "creations", "creations lto's", "breakfast grill", "chef's corner lto's", "chef's corner", "international", "oven", "taco bar", "breakfast", "grill breakfast", "grill", "the grill dinner", "vegetarian entrees", "special salad station", "veggie valley", "pasta/noodles", "pizza", "simple servings", "vegetables", "miscellaneous", "soups", "soup bar", "specialty salads", "hmc special salad", "salad", "hmc salad", "stg", "dessert", "desserts", "fruit bar", "bakery", "salad bar yogurt"]
          - truncated: {"breakfast grill": 5, "salad bar": -1, "grill": 3, "omelet bar": -1, "breakfast": 12, "breakfast @home": 3, "breakfast options": -1, "international": 6, "burger shack": -1}
          - combined: {"Special Salad Station": ["hmc salad", "special hot station salad north", "special bar salad-s", "special hot station salad south", "special station salad north", "special station salad south"], "Miscellaneous": ["misc", "-"], "Soups": ["stew", "stews", "soup"], "Breakfast Grill": ["breakfast grill", "grill breakfast"], "The Grill Dinner": ["the grill dinner"], "Entree": ["entree", "entrees", "entree", "entrees"]}
          Note: "Entree" in v1 uses accent ("Entree"/"Entrees"/"Entree"/"Entrees"). Check if the v1 PHP uses "Entree" or "Entrée" -- the PHP file shows "Entrée" with accent. Use "Entrée" as the canonical display name with aliases ["entree", "entrees", "entree", "entrees"] (lowercase without accent for matching).

          `BONAPPETIT_FILTER = StationFilterConfig(...)` from NewBonAppetitParser.php:
          - hidden: ["breakfast toppings", "breads, bagels and spreads", "cold cereals", "cold cereal", "fruits and yogurts", "beverage", "beverages", "build your own sandwich", "cereal", "toppings & condiments", "deli bar"]
          - ordered: ["chef's table", "main plate", "breakfast", "breakfast @home", "@home", "@ home", "breakfast options", "expo", "global", "options", "expo - mongolian", "expo - little italy", "grill", "pasta - express", "ovens", "collins late night snack", "ovens", "vegan", "vegan salads", "vegan - hummus & pita", "sweets", "stock pot", "stocks"]
          - truncated: {"breakfast grill": 5, "salad bar": -1, "grill": 3, "omelet bar": -1, "breakfast": 12, "breakfast @home": 3, "breakfast options": 5, "juice and smoothie bar": -1, "expo - mongolian": -1, "expo - little italy": 3, "chef's table - pasta bar": -1, "chef's table - taco bar": -1}
          - combined: {"grill special": ["grill"], "sweets": ["sweets", "chocolate chip cookies"], "main plate": ["main plate", "main plate in balance"], "ovens": ["ovens", "ovens2"]}

          `POMONA_FILTER = StationFilterConfig(...)` from PomonaJSONParser.php:
          - hidden: [] (Pomona has no hidden stations in v1)
          - ordered: ["entree", "expo", "grill", "mainline", "starch", "pizza", "allergen friendly station", "salad", "salad bar", "vegetable", "vegan/veggie", "soup", "deli-salad", "dessert"]
          - truncated: {"breakfast grill": 5}
          - combined: {"Grill": ["grill", "grill station"], "Soup": ["soup", "soup station", "soups"], "Expo": ["expo", "expo station"]}

       d. Dietary tag normalization:

          `DIETARY_TAG_MAP: dict[str, str]` mapping vendor-specific lowercase labels to canonical tag strings:
          - Sodexo boolean fields: "isvegan" -> "vegan", "isvegetarian" -> "vegetarian", "ismindful" -> "mindful"
          - BAMCO cor_icon values: "vegan" -> "vegan", "vegetarian" -> "vegetarian", "made without gluten-containing ingredients" -> "gluten-free", "in balance" -> "balanced", "farm to fork" -> "farm-to-fork", "humane" -> "humane", "halal" -> "halal"
          - Pomona dietaryChoices: "vegetarian" -> "vegetarian", "vegan" -> "vegan", "gluten free" -> "gluten-free"

          `normalize_dietary_tags(raw_tags: list[str]) -> list[str]`: Takes raw vendor tags, returns sorted list of canonical tags. Unknown tags are dropped with a log warning.

       e. Sodexo station name normalization helper:
          `normalize_sodexo_station_name(raw_name: str) -> str`:
          - Strip trailing " SCR" suffix
          - If name is ALL CAPS, apply ucwords (title case) then fix "And" -> "and", "To" -> "to", "Hmc" -> "HMC"
          - If name is blank, whitespace-only, or just "-", return "Miscellaneous"
          - Strip leading/trailing whitespace

    3. Create `backend/app/parsers/__init__.py` re-exporting BaseParser and filter configs.
  </action>
  <verify>
    - `cd /Users/felixpeng/Downloads/repos/5c-menu/backend && python -c "from app.parsers.station_filters import SODEXO_FILTER, BONAPPETIT_FILTER, POMONA_FILTER, apply_station_filters; print(f'Sodexo hidden: {len(SODEXO_FILTER.hidden)}, BA hidden: {len(BONAPPETIT_FILTER.hidden)}, Pomona hidden: {len(POMONA_FILTER.hidden)}')"` prints correct counts (12, 11, 0)
    - `cd /Users/felixpeng/Downloads/repos/5c-menu/backend && python -c "from app.parsers.base import BaseParser; print('BaseParser OK')"` succeeds
    - `cd /Users/felixpeng/Downloads/repos/5c-menu/backend && python -c "
from app.parsers.station_filters import apply_station_filters, SODEXO_FILTER
from app.models.menu import ParsedStation, ParsedMenuItem
stations = [
    ParsedStation(name='Salad Bar', items=[ParsedMenuItem(name='Caesar')]),
    ParsedStation(name='Exhibition', items=[ParsedMenuItem(name='Chicken')]),
    ParsedStation(name='Grill', items=[ParsedMenuItem(name='Burger'), ParsedMenuItem(name='Fries'), ParsedMenuItem(name='Hot Dog'), ParsedMenuItem(name='Wings')]),
]
result = apply_station_filters(stations, SODEXO_FILTER)
names = [s.name for s in result]
print(f'Stations after filter: {names}')
assert 'Salad Bar' not in [s.name.lower() for s in result], 'Salad bar should be hidden'
assert result[0].name == 'Exhibition', 'Exhibition should be first'
grill = [s for s in result if s.name.lower() == 'grill'][0]
assert len(grill.items) == 3, f'Grill should be truncated to 3, got {len(grill.items)}'
print('Station filter test PASSED')
"` passes
  </verify>
  <done>
    - BaseParser abstract class importable with fetch_raw, parse, validate, fetch_and_parse methods
    - All 3 vendor station filter configs match v1 PHP constants exactly
    - apply_station_filters pipeline correctly hides, merges, truncates, and sorts stations
    - Dietary tag normalization maps all known vendor labels to canonical tags
    - Sodexo station name normalization handles SCR suffix, ALL CAPS, blank names
  </done>
</task>

</tasks>

<verification>
- All models and parser infrastructure importable: `python -c "from app.models import *; from app.parsers import *"`
- Station filter configs have correct counts matching v1 PHP
- apply_station_filters produces correct output for sample data
- No circular imports between models and parsers
</verification>

<success_criteria>
- Python project installs cleanly with all dependencies
- SQLModel Menu table with JSONB stations_json column defined
- ParsedMenu/ParsedStation/ParsedMenuItem Pydantic models for parser output
- BaseParser ABC with fetch_raw/parse separation
- Station filter configs for all 3 vendors matching v1 PHP exactly
- Dietary tag normalization covers Sodexo, BAMCO, and Pomona labels
</success_criteria>

<output>
After completion, create `.planning/phases/01-parsers-data-models/01-01-SUMMARY.md`
</output>
