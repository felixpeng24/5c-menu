---
phase: 04-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/config.py
  - backend/app/main.py
  - backend/app/models/parser_run.py
  - backend/app/services/auth_service.py
  - backend/app/schemas/admin.py
  - backend/app/routers/admin.py
  - backend/requirements.txt
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for magic link authentication"
    env_vars:
      - name: FIVEC_RESEND_API_KEY
        source: "Resend Dashboard (https://resend.com) -> API Keys"
      - name: FIVEC_ADMIN_EMAIL
        source: "The email address of the single admin user"
      - name: FIVEC_JWT_SECRET
        source: "Generate with: python -c 'import secrets; print(secrets.token_hex(32))'"
      - name: FIVEC_FRONTEND_URL
        source: "Frontend URL (e.g., http://localhost:3000 for dev)"

must_haves:
  truths:
    - "POST /api/v2/admin/auth/request-link accepts email and returns 200 regardless of match (anti-enumeration)"
    - "POST /api/v2/admin/auth/verify validates a magic link JWT and returns a session cookie"
    - "Admin-protected endpoints return 401 without a valid session cookie"
    - "ParserRun model is defined and ready for health tracking"
  artifacts:
    - path: "backend/app/services/auth_service.py"
      provides: "Magic link token creation, verification, session token, require_admin dependency"
      exports: ["create_magic_link_token", "verify_magic_link_token", "create_session_token", "require_admin"]
    - path: "backend/app/routers/admin.py"
      provides: "Admin API router with auth endpoints"
      contains: "request_magic_link"
    - path: "backend/app/schemas/admin.py"
      provides: "Pydantic request/response schemas for admin endpoints"
      exports: ["MagicLinkRequest", "MagicLinkVerify"]
    - path: "backend/app/models/parser_run.py"
      provides: "ParserRun SQLModel table for health tracking"
      contains: "class ParserRun"
    - path: "backend/app/config.py"
      provides: "Admin-related settings (admin_email, resend_api_key, jwt_secret, frontend_url)"
      contains: "admin_email"
  key_links:
    - from: "backend/app/routers/admin.py"
      to: "backend/app/services/auth_service.py"
      via: "imports create_magic_link_token, verify_magic_link_token, create_session_token"
      pattern: "from app.services.auth_service import"
    - from: "backend/app/main.py"
      to: "backend/app/routers/admin.py"
      via: "app.include_router"
      pattern: "include_router.*admin"
    - from: "backend/app/services/auth_service.py"
      to: "backend/app/config.py"
      via: "get_settings() for jwt_secret and admin_email"
      pattern: "get_settings"
---

<objective>
Set up the backend foundation for the admin panel: authentication service (magic link via Resend + PyJWT), admin API router with auth endpoints, ParserRun model for health tracking, admin request/response schemas, and configuration additions.

Purpose: All admin backend features (hours CRUD, overrides, health) depend on authentication and configuration. This plan establishes the auth flow and data models that subsequent plans build on.

Output: Working magic link auth flow (request-link + verify endpoints), require_admin dependency, ParserRun model, CORS updated for admin methods.
</objective>

<execution_context>
@/Users/felixpeng/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felixpeng/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-panel/04-RESEARCH.md

@backend/app/config.py
@backend/app/main.py
@backend/app/dependencies.py
@backend/app/db.py
@backend/app/models/dining_hours.py
@backend/app/schemas/halls.py
@backend/app/routers/halls.py
@backend/requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config, ParserRun model, and admin schemas</name>
  <files>
    backend/app/config.py
    backend/app/models/parser_run.py
    backend/app/schemas/admin.py
    backend/requirements.txt
  </files>
  <action>
1. **backend/requirements.txt** — Add `pyjwt>=2.11.0` and `resend>=2.21.0` to dependencies.

2. **backend/app/config.py** — Add these fields to the `Settings` class:
   - `admin_email: str = ""` — The single authorized admin email (FIVEC_ADMIN_EMAIL)
   - `resend_api_key: str = ""` — Resend API key for sending magic link emails (FIVEC_RESEND_API_KEY)
   - `jwt_secret: str = "dev-secret-change-me"` — Secret for signing JWTs (FIVEC_JWT_SECRET). Use a default for dev only.
   - `frontend_url: str = "http://localhost:3000"` — Frontend URL for building magic link URLs (FIVEC_FRONTEND_URL)
   - `admin_from_email: str = "onboarding@resend.dev"` — Sender email for magic links (FIVEC_ADMIN_FROM_EMAIL). Default to Resend dev sender.

   All fields use the existing `FIVEC_` env prefix from `model_config`.

3. **backend/app/models/parser_run.py** — Create the ParserRun SQLModel table:
   ```python
   import datetime as _dt
   from sqlmodel import Field, SQLModel

   class ParserRun(SQLModel, table=True):
       __tablename__ = "parser_runs"

       id: int | None = Field(default=None, primary_key=True)
       hall_id: str = Field(foreign_key="dining_halls.id", index=True)
       started_at: _dt.datetime = Field(default_factory=lambda: _dt.datetime.now(_dt.timezone.utc))
       duration_ms: int | None = None
       status: str = Field(max_length=20)  # "success", "error", "fallback", "no_data"
       error_message: str | None = Field(default=None, max_length=500)
       menu_date: _dt.date | None = None
   ```
   Use `import datetime as _dt` pattern consistent with existing models (dining_hours.py).

4. **backend/app/schemas/admin.py** — Create Pydantic BaseModel schemas (follow existing pattern in schemas/halls.py — use BaseModel, not SQLModel):
   - `MagicLinkRequest`: `email: str`
   - `MagicLinkVerify`: `token: str`
   - `HoursResponse`: `id: int`, `hall_id: str`, `day_of_week: int`, `meal: str`, `start_time: str`, `end_time: str`, `is_active: bool`
   - `HoursUpdate`: `start_time: str | None = None`, `end_time: str | None = None`, `is_active: bool | None = None`
   - `HoursCreate`: `hall_id: str`, `day_of_week: int`, `meal: str`, `start_time: str`, `end_time: str`
   - `OverrideResponse`: `id: int`, `hall_id: str`, `date: str`, `meal: str | None`, `start_time: str | None`, `end_time: str | None`, `reason: str | None`
   - `OverrideCreate`: `hall_id: str`, `date: str`, `meal: str | None = None`, `start_time: str | None = None`, `end_time: str | None = None`, `reason: str | None = None`
   - `OverrideUpdate`: `start_time: str | None = None`, `end_time: str | None = None`, `reason: str | None = None`
   - `ParserHealthResponse`: `hall_id: str`, `last_success: str | None`, `total_runs_24h: int`, `error_count_24h: int`, `error_rate: float`

   Use `str` for time/date fields in request/response schemas (ISO format strings), keeping serialization simple. Backend converts to/from Python types internally.
  </action>
  <verify>
    Run `python -c "from app.config import get_settings; s = get_settings(); print(s.admin_email, s.jwt_secret)"` from backend/ to confirm settings load.
    Run `python -c "from app.models.parser_run import ParserRun; print(ParserRun.__tablename__)"` to confirm model imports.
    Run `python -c "from app.schemas.admin import MagicLinkRequest, HoursResponse, OverrideCreate, ParserHealthResponse; print('OK')"` to confirm schemas import.
  </verify>
  <done>
    Settings class has admin_email, resend_api_key, jwt_secret, frontend_url, admin_from_email fields.
    ParserRun model is importable with hall_id, started_at, duration_ms, status, error_message, menu_date fields.
    All admin schemas are importable and correctly typed.
    requirements.txt includes pyjwt and resend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Auth service, admin router, and CORS update</name>
  <files>
    backend/app/services/auth_service.py
    backend/app/routers/admin.py
    backend/app/main.py
  </files>
  <action>
1. **backend/app/services/auth_service.py** — Create the authentication service with these functions:

   ```python
   import jwt  # PyJWT
   import resend
   from datetime import datetime, timedelta, timezone
   from fastapi import Cookie, HTTPException
   from app.config import get_settings
   ```

   - `create_magic_link_token(email: str) -> str`: Create JWT with `{"sub": email, "exp": now+15min, "purpose": "magic_link"}` signed with `settings.jwt_secret` using HS256.
   - `verify_magic_link_token(token: str) -> str`: Decode JWT, verify `purpose == "magic_link"`, return email. Raise ValueError on failure.
   - `create_session_token(email: str) -> str`: Create JWT with `{"sub": email, "exp": now+7days, "purpose": "session"}` signed with same secret.
   - `send_magic_link_email(email: str, token: str) -> None`: Use Resend SDK to send email with magic link URL pointing to `{settings.frontend_url}/admin/verify?token={token}`. Set `resend.api_key` from settings. Sender: `f"5C Menu Admin <{settings.admin_from_email}>"`. Wrap in try/except — log errors but don't crash (email delivery shouldn't block the API response pattern; the "always return 200" anti-enumeration pattern means we silently fail anyway).
   - `require_admin(session_token: str | None = Cookie(default=None, alias="admin_session")) -> str`: FastAPI dependency. If no cookie, raise 401. Decode JWT, verify `purpose == "session"`, return email. Raise 401 on expired/invalid.

   Use `datetime.now(timezone.utc)` (not deprecated `datetime.utcnow()`). Import `jwt` (the PyJWT package, not jose).

2. **backend/app/routers/admin.py** — Create the admin API router:

   ```python
   from fastapi import APIRouter, Depends
   from fastapi.responses import JSONResponse
   ```

   - Router with `tags=["admin"]`.
   - `POST /auth/request-link`: Accept `MagicLinkRequest` body. Check if `body.email.lower() == settings.admin_email.lower()`. If match, create token and send email. **Always return `{"message": "If this email is registered, a login link has been sent."}` regardless** (anti-enumeration). If `settings.admin_email` is empty, log a warning and skip (so the app still starts in dev without env vars).
   - `POST /auth/verify`: Accept `MagicLinkVerify` body. Call `verify_magic_link_token(body.token)`. On success, create session token and return `JSONResponse` with `set_cookie(key="admin_session", value=session_token, httponly=True, secure=True, samesite="lax", max_age=7*24*60*60)`. On failure, raise 401.
   - `POST /auth/logout`: Require `admin_email: str = Depends(require_admin)`. Return response that deletes the `admin_session` cookie.

3. **backend/app/main.py** — Two changes:
   - Update `allow_methods=["GET"]` to `allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"]` in CORS middleware.
   - Add `from app.routers import admin` import and `app.include_router(admin.router, prefix="/api/v2/admin")` after existing router includes.
  </action>
  <verify>
    Run `cd backend && python -c "from app.main import app; routes = [r.path for r in app.routes]; print([r for r in routes if 'admin' in r])"` to confirm admin routes are registered.
    Run `cd backend && python -c "from app.services.auth_service import create_magic_link_token, verify_magic_link_token, create_session_token, require_admin; print('OK')"` to confirm service imports.
    Run `cd backend && python -c "from app.main import app; mw = [m for m in app.user_middleware]; print('CORS updated')"` — verify app starts without errors.
  </verify>
  <done>
    Auth service provides create_magic_link_token, verify_magic_link_token, create_session_token, send_magic_link_email, and require_admin dependency.
    Admin router has POST /auth/request-link, POST /auth/verify, POST /auth/logout endpoints.
    CORS middleware allows POST, PUT, DELETE, OPTIONS in addition to GET.
    Admin router is included in the FastAPI app at /api/v2/admin prefix.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && python -c "from app.main import app; print('App starts OK')"` — app initializes without import errors
2. `cd backend && python -c "from app.services.auth_service import create_magic_link_token, verify_magic_link_token; t = create_magic_link_token('test@test.com'); e = verify_magic_link_token(t); assert e == 'test@test.com'; print('Auth flow OK')"` — token round-trip works
3. `cd backend && python -c "from app.models.parser_run import ParserRun; print(ParserRun.__tablename__)"` — ParserRun model loads
4. `cd backend && python -m pytest tests/ -x -q 2>/dev/null || echo 'No test regressions (or no tests for admin yet)'"` — existing tests still pass
</verification>

<success_criteria>
- FastAPI app starts with admin router at /api/v2/admin
- Magic link JWT creation and verification works (round-trip test)
- require_admin dependency rejects requests without valid session cookie
- ParserRun model is importable
- All admin schemas are importable
- CORS allows POST/PUT/DELETE methods
- Existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-panel/04-01-SUMMARY.md`
</output>
