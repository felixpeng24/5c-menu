---
phase: 04-admin-panel
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - web/src/app/admin/hours/page.tsx
  - web/src/app/admin/overrides/page.tsx
  - web/src/app/admin/health/page.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can see all dining hours in a halls-by-days grid at /admin/hours"
    - "Admin can click a cell to edit start/end times and save changes"
    - "Admin can create a new hours entry for a hall/day/meal combination"
    - "Admin can see all date overrides in a list at /admin/overrides"
    - "Admin can create a new override specifying hall, date, meal, times, and reason"
    - "Admin can delete an existing override"
    - "Admin can see parser health status per hall at /admin/health with last success time and error rate"
  artifacts:
    - path: "web/src/app/admin/hours/page.tsx"
      provides: "Hours grid editor page (ADM-02)"
      contains: "hours"
    - path: "web/src/app/admin/overrides/page.tsx"
      provides: "Overrides manager page (ADM-03)"
      contains: "overrides"
    - path: "web/src/app/admin/health/page.tsx"
      provides: "Parser health dashboard page (ADM-04)"
      contains: "health"
  key_links:
    - from: "web/src/app/admin/hours/page.tsx"
      to: "web/src/lib/admin-api.ts"
      via: "fetchHours, updateHours, createHours"
      pattern: "fetchHours|updateHours"
    - from: "web/src/app/admin/overrides/page.tsx"
      to: "web/src/lib/admin-api.ts"
      via: "fetchOverrides, createOverride, deleteOverride"
      pattern: "fetchOverrides|createOverride"
    - from: "web/src/app/admin/health/page.tsx"
      to: "web/src/lib/admin-api.ts"
      via: "fetchHealth"
      pattern: "fetchHealth"
---

<objective>
Build the three admin feature pages: hours grid editor (ADM-02), overrides manager (ADM-03), and parser health dashboard (ADM-04). These pages consume the CRUD endpoints built in Plan 02 and render within the admin layout built in Plan 03.

Purpose: These pages complete the admin panel, allowing the admin to manage dining hours, create holiday overrides, and monitor parser health.

Output: Three fully functional admin pages accessible at /admin/hours, /admin/overrides, /admin/health.
</objective>

<execution_context>
@/Users/felixpeng/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felixpeng/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-panel/04-RESEARCH.md
@.planning/phases/04-admin-panel/04-02-SUMMARY.md
@.planning/phases/04-admin-panel/04-03-SUMMARY.md

@web/src/lib/admin-api.ts
@web/src/app/admin/layout.tsx
@web/src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hours grid editor and overrides manager pages</name>
  <files>
    web/src/app/admin/hours/page.tsx
    web/src/app/admin/overrides/page.tsx
  </files>
  <action>
Both pages are `"use client"` components.

**Hours Grid Editor (/admin/hours):**

The hours grid shows a table of dining hours organized by hall. The approach: fetch all hours, render a table grouped by hall, with editable rows.

1. State management:
   - `hours`: array from `fetchHours()`, loaded on mount
   - `loading`: boolean for initial load
   - `editingId`: `number | null` — which row is being edited
   - `editValues`: `{ start_time: string, end_time: string, is_active: boolean }` — form values for the editing row
   - `showCreateForm`: boolean for new entry form
   - `createValues`: `{ hall_id: string, day_of_week: number, meal: string, start_time: string, end_time: string }`

2. Load data on mount with `useEffect(() => { fetchHours().then(setHours).finally(() => setLoading(false)) }, [])`.

3. Render a `<table>` with columns: Hall, Day, Meal, Start, End, Active, Actions.
   - Day column: convert `day_of_week` (0=Sun..6=Sat) to day name using array `["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]`.
   - When not editing: show text values and "Edit" button.
   - When editing (row.id === editingId): show `<input type="time">` for start/end, checkbox for is_active, "Save" and "Cancel" buttons.
   - "Save" calls `updateHours(editingId, editValues)`, then refreshes the list.
   - "Delete" button calls `deleteHours(id)` with confirmation (`window.confirm`), then refreshes.

4. "Add Hours" button toggles `showCreateForm`. Create form: select for hall_id (use hardcoded hall IDs from constants or fetch from /halls), select for day_of_week (0-6), input for meal, time inputs for start/end. Submit calls `createHours(createValues)`, refreshes list, hides form.

5. Styling: simple Tailwind table with `border-collapse`, `border border-gray-200`, `px-3 py-2` cells, hover state on rows. Edit inputs with border and padding. Buttons styled as small text buttons (blue for edit/save, red for delete).

**Overrides Manager (/admin/overrides):**

1. State management:
   - `overrides`: array from `fetchOverrides()`
   - `loading`: boolean
   - `showCreateForm`: boolean
   - `createValues`: `{ hall_id: string, date: string, meal: string, start_time: string, end_time: string, reason: string }`

2. Load on mount.

3. Render a list/table of overrides with columns: Hall, Date, Meal, Start, End, Reason, Actions.
   - Show "closed" if start_time is null (override with no times means closed).
   - "Delete" button with confirmation.
   - "Edit" button (optional, simpler: just delete and recreate).

4. "Add Override" button toggles create form. Form fields:
   - Hall ID: select (hardcoded hall list or text input)
   - Date: `<input type="date">`
   - Meal: text input (or select with Breakfast/Lunch/Dinner options)
   - Start time: `<input type="time">` (leave blank for closure)
   - End time: `<input type="time">`
   - Reason: text input
   - Note: If both start and end time are empty, the override represents a closure for that meal.

5. Submit calls `createOverride(createValues)`. Handle empty time fields as null in the request body.

6. Styling: same Tailwind table pattern as hours page.

For both pages, use the hall IDs from the existing constants. Import `HALL_MEALS` or define a simple `HALL_IDS` array:
```typescript
const HALL_IDS = ["hoch", "collins", "malott", "mcconnell", "frank", "frary", "oldenborg"]
const DAY_NAMES = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
const MEALS = ["Breakfast", "Lunch", "Dinner"]
```
  </action>
  <verify>
    Run `cd web && npx tsc --noEmit` — TypeScript compiles without errors.
    Run `cd web && npm run build` — Next.js build succeeds.
  </verify>
  <done>
    /admin/hours renders a table of all dining hours with inline edit capability.
    Admin can edit start/end times and active status for any hours entry.
    Admin can create new hours entries and delete existing ones.
    /admin/overrides renders a list of all date overrides.
    Admin can create new overrides (including closure overrides with no times) and delete existing ones.
    Both pages compile and build successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Parser health dashboard page</name>
  <files>
    web/src/app/admin/health/page.tsx
  </files>
  <action>
`"use client"` component.

**Parser Health Dashboard (/admin/health):**

1. State: `health` (array from fetchHealth()), `loading` (boolean), `error` (string | null).

2. Load on mount with `useEffect`. Add a "Refresh" button that reloads data.

3. Render a dashboard with cards for each hall showing:
   - Hall ID (formatted nicely — capitalize or use a display name map)
   - Last successful fetch time (relative time like "5 minutes ago" or "Never" if null)
   - Total runs in last 24 hours
   - Error count in last 24 hours
   - Error rate (percentage, with color coding: green < 10%, yellow 10-30%, red > 30%)

4. Use a grid layout: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`.

5. Each card: `border rounded-lg p-4` with:
   - Hall name as bold heading
   - Status indicator: green dot for healthy (error_rate < 10%), yellow for degraded (10-30%), red for unhealthy (>30%), gray for no data (total_runs_24h === 0)
   - Stats in a simple list

6. For "last success" relative time, compute from ISO string:
   ```typescript
   function timeAgo(isoString: string | null): string {
     if (!isoString) return "Never"
     const diff = Date.now() - new Date(isoString).getTime()
     const minutes = Math.floor(diff / 60000)
     if (minutes < 1) return "Just now"
     if (minutes < 60) return `${minutes}m ago`
     const hours = Math.floor(minutes / 60)
     if (hours < 24) return `${hours}h ago`
     const days = Math.floor(hours / 24)
     return `${days}d ago`
   }
   ```

7. Empty state: "No parser data available. Parsers will appear here after their first execution." shown when health array is empty.

8. Display a summary at the top: "X of Y parsers healthy" based on error rates.

Styling: cards with subtle shadows, status dots using colored `rounded-full w-3 h-3 inline-block` spans.
  </action>
  <verify>
    Run `cd web && npx tsc --noEmit` — TypeScript compiles without errors.
    Run `cd web && npm run build` — Next.js build succeeds.
    Run `cd web && npm run test:run 2>/dev/null || echo 'Existing tests still pass'` — no test regressions.
  </verify>
  <done>
    /admin/health renders a dashboard with parser status cards for each hall.
    Each card shows last success time, total runs, error count, and error rate.
    Color-coded status indicators (green/yellow/red/gray) convey health at a glance.
    "Refresh" button reloads health data.
    Page compiles and builds successfully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete admin panel</name>
  <files>web/src/app/admin/hours/page.tsx</files>
  <action>
    Human verification of the complete admin panel. What was built:
    - Magic link authentication (ADM-01)
    - Hours grid editor (ADM-02)
    - Date overrides manager (ADM-03)
    - Parser health dashboard (ADM-04)
  </action>
  <verify>
    1. Start backend: `cd backend && uvicorn app.main:app --reload`
    2. Start frontend: `cd web && npm run dev`
    3. Visit http://localhost:3000/admin — should redirect to /admin/login
    4. Enter admin email and submit — should show "Check your email" message (or check terminal for Resend output)
    5. If env vars aren't set for Resend, manually test verification:
       - In another terminal: `cd backend && python -c "from app.services.auth_service import create_magic_link_token; print(create_magic_link_token('your-email'))"`
       - Visit http://localhost:3000/admin/verify?token=PASTE_TOKEN_HERE
       - Should redirect to /admin/hours
    6. Verify /admin/hours shows the hours grid (may be empty initially)
    7. Verify /admin/overrides shows the overrides list
    8. Verify /admin/health shows the health dashboard
    9. Verify navigation links between all three admin pages work
    10. Verify visiting /admin redirects to /admin/hours
  </verify>
  <done>Human has verified the complete admin panel works end-to-end. Type "approved" or describe issues to fix.</done>
</task>

</tasks>

<verification>
1. `cd web && npx tsc --noEmit` — TypeScript compiles
2. `cd web && npm run build` — Next.js builds successfully
3. All three admin pages exist and render
4. Navigation between pages works
5. Human verification of the full auth flow
</verification>

<success_criteria>
- Hours grid displays all dining hours with edit/create/delete functionality
- Overrides page displays all overrides with create/delete functionality
- Health dashboard shows per-hall parser status with color-coded indicators
- All pages accessible only when authenticated (middleware redirect works)
- Human has verified the complete admin flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-panel/04-04-SUMMARY.md`
</output>
