---
phase: 04-admin-panel
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - web/src/middleware.ts
  - web/src/app/admin/layout.tsx
  - web/src/app/admin/login/page.tsx
  - web/src/app/admin/verify/page.tsx
  - web/src/lib/admin-api.ts
autonomous: true

must_haves:
  truths:
    - "Visiting /admin/hours without a session cookie redirects to /admin/login"
    - "Admin can enter their email on /admin/login and submit to request a magic link"
    - "Visiting /admin/verify?token=xxx calls the backend verify endpoint and stores the session cookie"
    - "After successful verification, admin is redirected to /admin/hours"
    - "Admin layout shows navigation links to Hours, Overrides, and Health pages"
  artifacts:
    - path: "web/src/middleware.ts"
      provides: "Route protection for /admin/* paths"
      contains: "admin_session"
    - path: "web/src/app/admin/layout.tsx"
      provides: "Admin panel layout with navigation"
      contains: "AdminLayout"
    - path: "web/src/app/admin/login/page.tsx"
      provides: "Magic link login form"
      contains: "request-link"
    - path: "web/src/app/admin/verify/page.tsx"
      provides: "Magic link verification handler"
      contains: "verify"
    - path: "web/src/lib/admin-api.ts"
      provides: "Admin API client functions"
      exports: ["requestMagicLink", "verifyMagicLink"]
  key_links:
    - from: "web/src/middleware.ts"
      to: "/admin/login"
      via: "redirect when admin_session cookie missing"
      pattern: "admin_session"
    - from: "web/src/app/admin/verify/page.tsx"
      to: "web/src/lib/admin-api.ts"
      via: "calls verifyMagicLink to exchange token for session"
      pattern: "verifyMagicLink"
    - from: "web/src/lib/admin-api.ts"
      to: "/api/v2/admin"
      via: "fetch calls to backend admin endpoints"
      pattern: "api/v2/admin"
---

<objective>
Build the frontend authentication flow for the admin panel: Next.js middleware for route protection, admin layout with navigation, login page, verification page, and admin API client.

Purpose: This establishes the authenticated admin shell that the admin feature pages (hours, overrides, health) will render within. Without auth, admin pages cannot be accessed.

Output: Working admin auth flow — login form sends magic link request, verify page exchanges token for session cookie, middleware protects all admin routes except login/verify.
</objective>

<execution_context>
@/Users/felixpeng/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felixpeng/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-panel/04-RESEARCH.md
@.planning/phases/04-admin-panel/04-01-SUMMARY.md

@web/src/app/layout.tsx
@web/src/lib/api.ts
@web/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin API client and Next.js middleware</name>
  <files>
    web/src/lib/admin-api.ts
    web/src/middleware.ts
  </files>
  <action>
1. **web/src/lib/admin-api.ts** — Create the admin API client. Follow the pattern in `web/src/lib/api.ts` (use `API_BASE` from env).

   ```typescript
   const API_BASE = process.env.NEXT_PUBLIC_API_URL ?? "http://localhost:8000"

   async function adminFetch<T>(path: string, options?: RequestInit): Promise<T> {
     const res = await fetch(`${API_BASE}/api/v2/admin${path}`, {
       credentials: "include",  // Send cookies cross-origin
       ...options,
     })
     if (!res.ok) {
       const body = await res.json().catch(() => ({}))
       throw new Error(body.detail ?? `Admin API error: ${res.status}`)
     }
     return res.json()
   }
   ```

   Export these functions:
   - `requestMagicLink(email: string)`: POST to `/auth/request-link` with JSON body `{ email }`. Returns `{ message: string }`.
   - `verifyMagicLink(token: string)`: POST to `/auth/verify` with JSON body `{ token }`. Returns `{ message: string }`. **Important:** This endpoint sets an HttpOnly cookie via Set-Cookie header. The `credentials: "include"` ensures the browser stores it.
   - `logout()`: POST to `/auth/logout`. Returns `{ message: string }`.
   - `fetchHours()`: GET `/hours`. Returns array of hours.
   - `createHours(data)`: POST `/hours` with JSON body.
   - `updateHours(id: number, data)`: PUT `/hours/${id}` with JSON body.
   - `deleteHours(id: number)`: DELETE `/hours/${id}`.
   - `fetchOverrides()`: GET `/overrides`. Returns array of overrides.
   - `createOverride(data)`: POST `/overrides` with JSON body.
   - `updateOverride(id: number, data)`: PUT `/overrides/${id}` with JSON body.
   - `deleteOverride(id: number)`: DELETE `/overrides/${id}`.
   - `fetchHealth()`: GET `/health`. Returns array of parser health records.

   For POST/PUT/DELETE calls, set `method` and `headers: { "Content-Type": "application/json" }` and `body: JSON.stringify(data)`.

2. **web/src/middleware.ts** — Create Next.js middleware for admin route protection.

   ```typescript
   import { NextRequest, NextResponse } from "next/server"

   const publicAdminPaths = ["/admin/login", "/admin/verify"]

   export function middleware(req: NextRequest) {
     const { pathname } = req.nextUrl

     if (pathname.startsWith("/admin") && !publicAdminPaths.includes(pathname)) {
       const session = req.cookies.get("admin_session")?.value
       if (!session) {
         return NextResponse.redirect(new URL("/admin/login", req.url))
       }
     }

     return NextResponse.next()
   }

   export const config = {
     matcher: ["/admin/:path*"],
   }
   ```

   This is optimistic protection only. The real security is the `require_admin` dependency on the backend. Even if middleware is bypassed, API calls fail without a valid cookie.
  </action>
  <verify>
    Run `cd web && npx tsc --noEmit` — TypeScript compiles without errors.
    Run `cd web && npm run build 2>&1 | tail -5` — Next.js build succeeds (middleware is validated at build time).
  </verify>
  <done>
    admin-api.ts provides typed functions for all admin API endpoints with credentials: "include".
    middleware.ts redirects unauthenticated users from /admin/* to /admin/login (except /admin/login and /admin/verify).
    TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin layout, login page, and verify page</name>
  <files>
    web/src/app/admin/layout.tsx
    web/src/app/admin/login/page.tsx
    web/src/app/admin/verify/page.tsx
    web/src/app/admin/page.tsx
  </files>
  <action>
1. **web/src/app/admin/layout.tsx** — Create the admin layout (nested within root layout).

   This is a server component (no "use client"). It wraps admin pages with a header/nav bar.

   ```tsx
   import Link from "next/link"

   export default function AdminLayout({ children }: { children: React.ReactNode }) {
     return (
       <div className="min-h-screen bg-white dark:bg-gray-950">
         <nav className="border-b border-gray-200 dark:border-gray-800 px-4 py-3">
           <div className="max-w-5xl mx-auto flex items-center justify-between">
             <Link href="/admin" className="text-lg font-semibold">
               5C Menu Admin
             </Link>
             <div className="flex gap-4 text-sm">
               <Link href="/admin/hours" className="hover:underline">Hours</Link>
               <Link href="/admin/overrides" className="hover:underline">Overrides</Link>
               <Link href="/admin/health" className="hover:underline">Health</Link>
             </div>
           </div>
         </nav>
         <main className="max-w-5xl mx-auto p-4">
           {children}
         </main>
       </div>
     )
   }
   ```

   Use Next.js `Link` component (not `<a>`) for client-side navigation.

2. **web/src/app/admin/page.tsx** — Simple redirect page. When user visits /admin, redirect to /admin/hours.

   ```tsx
   import { redirect } from "next/navigation"
   export default function AdminPage() {
     redirect("/admin/hours")
   }
   ```

3. **web/src/app/admin/login/page.tsx** — Magic link login form. Mark as `"use client"`.

   State: `email` (string), `submitted` (boolean), `error` (string | null), `loading` (boolean).

   Form with single email input and submit button. On submit:
   - Set loading=true
   - Call `requestMagicLink(email)` from admin-api
   - Set submitted=true on success
   - Set error on failure
   - Set loading=false

   After submission, show "Check your email for a login link" message instead of the form.

   Styling: centered card with `max-w-md mx-auto mt-20`, simple Tailwind form styling. Input with `border rounded px-3 py-2 w-full`, button with `bg-blue-600 text-white rounded px-4 py-2 w-full`.

4. **web/src/app/admin/verify/page.tsx** — Magic link verification handler. Mark as `"use client"`.

   On mount (useEffect), read `token` from URL search params via `useSearchParams()`. Call `verifyMagicLink(token)`. On success, redirect to `/admin/hours` using `router.push()`. On failure, show error message with link back to `/admin/login`.

   State: `status` ("verifying" | "success" | "error"), `errorMessage` (string).

   Import `useRouter` from `next/navigation` and `useSearchParams` from `next/navigation`.

   Wrap in Suspense boundary if needed for useSearchParams (Next.js 15 requires this).

   ```tsx
   "use client"
   import { useEffect, useState, Suspense } from "react"
   import { useRouter, useSearchParams } from "next/navigation"
   import { verifyMagicLink } from "@/lib/admin-api"

   function VerifyContent() {
     const router = useRouter()
     const searchParams = useSearchParams()
     const [status, setStatus] = useState<"verifying" | "success" | "error">("verifying")
     const [errorMessage, setErrorMessage] = useState("")

     useEffect(() => {
       const token = searchParams.get("token")
       if (!token) {
         setStatus("error")
         setErrorMessage("No token provided")
         return
       }
       verifyMagicLink(token)
         .then(() => {
           setStatus("success")
           router.push("/admin/hours")
         })
         .catch((err) => {
           setStatus("error")
           setErrorMessage(err.message || "Verification failed")
         })
     }, [searchParams, router])

     // ... render based on status
   }

   export default function VerifyPage() {
     return (
       <Suspense fallback={<div className="text-center mt-20">Loading...</div>}>
         <VerifyContent />
       </Suspense>
     )
   }
   ```

   Show "Verifying your login..." while verifying, "Redirecting..." on success, error message with "Try again" link on failure.
  </action>
  <verify>
    Run `cd web && npx tsc --noEmit` — TypeScript compiles without errors.
    Run `cd web && npm run build` — Next.js build succeeds (all pages compile, middleware works).
    Verify routes exist: check that `web/src/app/admin/layout.tsx`, `web/src/app/admin/page.tsx`, `web/src/app/admin/login/page.tsx`, `web/src/app/admin/verify/page.tsx` all exist.
  </verify>
  <done>
    Admin layout renders nav with links to Hours, Overrides, Health.
    /admin redirects to /admin/hours.
    /admin/login shows email form that calls requestMagicLink.
    /admin/verify reads token from URL, calls verifyMagicLink, redirects to /admin/hours on success.
    Next.js build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd web && npx tsc --noEmit` — no TypeScript errors
2. `cd web && npm run build` — Next.js build succeeds
3. `ls web/src/app/admin/layout.tsx web/src/app/admin/login/page.tsx web/src/app/admin/verify/page.tsx web/src/middleware.ts web/src/lib/admin-api.ts` — all files exist
4. `cd web && npm run test:run 2>/dev/null || echo 'Existing tests still pass'` — no test regressions
</verification>

<success_criteria>
- Next.js middleware redirects unauthenticated /admin/* requests to /admin/login
- Login page renders email form and calls backend request-link endpoint
- Verify page exchanges token for session cookie and redirects to /admin/hours
- Admin layout provides consistent navigation across admin pages
- TypeScript compiles and Next.js builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-panel/04-03-SUMMARY.md`
</output>
