---
phase: 03-web-frontend
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - web/src/app/page.tsx
  - web/src/components/meal-tabs.tsx
autonomous: true

must_haves:
  truths:
    - "User sees all 7 dining halls in a vertical scroll feed with school color card backgrounds"
    - "User can tap meal tabs and see menu items grouped by station"
    - "User can toggle Open Now to filter feed to only open halls"
    - "User can navigate to any date within 7 days via date bar"
    - "Open/closed badges reflect live open-now API data"
    - "Stale data shows relative time banner"
  artifacts:
    - path: "web/src/app/page.tsx"
      provides: "Main page composing all components into hall feed"
      exports: ["default"]
      min_lines: 50
  key_links:
    - from: "web/src/app/page.tsx"
      to: "web/src/lib/hooks.ts"
      via: "calls useHalls and useOpenNow"
      pattern: "useHalls|useOpenNow"
    - from: "web/src/app/page.tsx"
      to: "web/src/components/hall-card.tsx"
      via: "maps halls to HallCard components"
      pattern: "HallCard"
    - from: "web/src/app/page.tsx"
      to: "web/src/components/date-bar.tsx"
      via: "renders DateBar with state callbacks"
      pattern: "DateBar"
    - from: "web/src/app/page.tsx"
      to: "web/src/components/open-now-toggle.tsx"
      via: "renders OpenNowToggle with filter state"
      pattern: "OpenNowToggle"
---

<objective>
Assemble the complete home page by composing all components into a vertical scroll feed of dining hall cards with date navigation, open-now filtering, and proper dark mode support.

Purpose: This is the main user-facing page -- the reason the app exists. Students open it and see all dining halls with menus, filtered by date and open status.
Output: A fully functional page.tsx that composes all previously-built components.
</objective>

<execution_context>
@/Users/felixpeng/.claude/get-shit-done/workflows/execute-plan.md
@/Users/felixpeng/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-web-frontend/03-RESEARCH.md
@.planning/phases/03-web-frontend/03-01-SUMMARY.md
@.planning/phases/03-web-frontend/03-02-SUMMARY.md
@.planning/phases/03-web-frontend/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build the home page with hall feed, date bar, and open-now filter</name>
  <files>
    web/src/app/page.tsx
  </files>
  <action>
    Create `web/src/app/page.tsx` as a `'use client'` component (needs hooks for state and queries):

    **State management:**
    - `selectedDate: string` -- YYYY-MM-DD, initialized to Pacific today using same helper as DateBar:
      ```ts
      () => new Date().toLocaleDateString('en-CA', { timeZone: 'America/Los_Angeles' })
      ```
    - `openNowFilter: boolean` -- initialized to `false`

    **Data fetching:**
    - `useHalls()` -- fetches all 7 dining halls (static metadata)
    - `useOpenNow()` -- fetches currently-open halls (polls every 60s via hook config)

    **Derived state:**
    - `openHallIds`: `Set<string>` built from `openNowData?.map(h => h.id) ?? []`
    - `openHallMeals`: `Map<string, string>` mapping hall ID to current_meal from open-now response
    - `filteredHalls`: if `openNowFilter` is true, filter `halls` to only those in `openHallIds`. If the selected date is NOT today (Pacific), disable the filter and show all halls (open-now only applies to today).
    - Determine if selected date is today: compare `selectedDate` against Pacific today string

    **Layout (mobile-first, 375px minimum):**
    ```
    <main className="min-h-screen bg-gray-50 dark:bg-gray-950">
      {/* Header */}
      <header className="sticky top-0 z-10 bg-gray-50/80 dark:bg-gray-950/80 backdrop-blur-sm px-4 pt-4 pb-2">
        <div className="flex items-center justify-between mb-3">
          <h1 className="text-2xl font-bold text-gray-900 dark:text-white">5C Menu</h1>
          <OpenNowToggle enabled={openNowFilter} onToggle={setOpenNowFilter} />
        </div>
        <DateBar selectedDate={selectedDate} onDateChange={setSelectedDate} />
      </header>

      {/* Hall feed */}
      <div className="px-4 pb-4 space-y-4">
        {isLoading && <LoadingSkeleton />}
        {error && <ErrorMessage />}
        {filteredHalls.map(hall => (
          <HallCard
            key={hall.id}
            hall={hall}
            date={selectedDate}
            isOpen={openHallIds.has(hall.id)}
            currentMeal={openHallMeals.get(hall.id)}
          />
        ))}
        {filteredHalls.length === 0 && !isLoading && (
          <EmptyState />
        )}
      </div>
    </main>
    ```

    **Loading state:** When halls are loading, show 3-4 Skeleton cards (rounded-2xl, h-48, animate-pulse).

    **Error state:** Show a centered error message with retry button that calls `refetch()`.

    **Empty state (open-now filter active, no halls open):** Show a friendly message like "No dining halls are currently open" with a suggestion to turn off the filter.

    **Responsive design (FE-11):**
    - The vertical scroll feed naturally works on mobile. No special breakpoints needed for the feed itself.
    - Max width on larger screens: `max-w-lg mx-auto` to keep the feed narrow and phone-like on desktop.
    - Header sticks to top on scroll (`sticky top-0 z-10`) with a blur backdrop.

    **Dark mode (FE-10):**
    - Background: `bg-gray-50 dark:bg-gray-950`
    - Text: `text-gray-900 dark:text-white`
    - Cards already handle dark mode via school colors (bold enough for both modes)
    - Tailwind v4 applies `dark:` variants via `prefers-color-scheme` automatically. No configuration needed.

    **Open-now filter behavior:**
    - When filter is ON and date is today: show only halls in openHallIds
    - When filter is ON but date is NOT today: disable filter silently (open-now only applies to current time). Optionally show a subtle note: "Open Now filter only applies to today"
    - When filter is OFF: show all 7 halls
  </action>
  <verify>
    Run `cd web && npm run build` -- build succeeds.
    Run `cd web && npx tsc --noEmit` -- no type errors.
    Verify page.tsx imports and uses: useHalls, useOpenNow, HallCard, DateBar, OpenNowToggle.
  </verify>
  <done>
    Home page renders all 7 halls in a vertical scroll feed. Date bar navigates 7 days. Open Now toggle filters to open halls. Loading/error/empty states handled. Mobile-responsive layout. Dark mode supported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MealTabs to use StaleBanner component and final polish</name>
  <files>
    web/src/components/meal-tabs.tsx
  </files>
  <action>
    Now that StaleBanner exists (from plan 03-03), update MealTabs to use it instead of the inline stale indicator:

    1. Replace the inline stale text with proper StaleBanner import and usage:
       ```tsx
       import { StaleBanner } from './stale-banner'
       ```
       Replace:
       ```tsx
       {data?.is_stale && data.fetched_at && (
         <p className="text-amber-300 text-xs mb-2">Data may be outdated</p>
       )}
       ```
       With:
       ```tsx
       {data && <StaleBanner isStale={data.is_stale} fetchedAt={data.fetched_at} />}
       ```

    2. Verify MealTabs still builds cleanly after the import change.

    3. Review the overall component composition chain one more time:
       - page.tsx -> HallCard -> MealTabs -> StationList -> MenuItem
       - page.tsx -> DateBar (callbacks)
       - page.tsx -> OpenNowToggle (callbacks)
       - MealTabs -> StaleBanner (conditional)
       Ensure all imports resolve and no circular dependencies exist.
  </action>
  <verify>
    Run `cd web && npm run build` -- build succeeds.
    Run `cd web && npx tsc --noEmit` -- no type errors.
    Verify MealTabs imports StaleBanner (not inline text).
  </verify>
  <done>
    MealTabs uses StaleBanner component for stale data display. Full component composition chain verified. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `cd web && npm run build` passes
2. `cd web && npx tsc --noEmit` passes
3. page.tsx uses useHalls, useOpenNow, HallCard, DateBar, OpenNowToggle
4. Hall feed shows all halls with school color backgrounds
5. Date bar defaults to Pacific today
6. Open Now toggle filters hall list
7. Loading skeletons show during data fetch
8. Empty state shown when no halls match filter
9. Dark mode classes present on all elements (bg, text, etc.)
10. Max-width applied for desktop readability
</verification>

<success_criteria>
- Full page renders with all 7 hall cards in vertical feed
- Date navigation works across 7 days
- Open Now filter toggles hall visibility
- Loading, error, and empty states are handled
- Mobile-first responsive layout (375px minimum, max-width on desktop)
- Dark mode via Tailwind dark: variants
- Stale data banner displays when data is outdated
</success_criteria>

<output>
After completion, create `.planning/phases/03-web-frontend/03-04-SUMMARY.md`
</output>
